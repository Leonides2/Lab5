name: Despliegue a Azure Container App

on:
  # El segundo workflow debe escuchar el evento 'repository_dispatch'
  repository_dispatch:
    types: [deploy_azure_container]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Leer datos del evento de trigger
        id: event_data
        run: |
          # El nombre completo de la imagen con tags se envía en el payload del evento
          IMAGE_LIST=$(jq -r '.client_payload.image_tag' "$GITHUB_EVENT_PATH")
          echo "Payload image list: $IMAGE_LIST"

          # take only the first comma-separated entry and trim leading/trailing spaces
          IMAGE_TAG=$(echo "$IMAGE_LIST" | cut -d',' -f1 | sed 's/^ *//;s/ *$//')

          # basic validation: non-empty and contains a tag (has a colon)
          if [[ -z "$IMAGE_TAG" || "$IMAGE_TAG" != *:* ]]; then
            echo "Error: IMAGE_TAG is missing or invalid: '$IMAGE_TAG'"
            exit 1
          fi

          echo "La imagen a desplegar es: $IMAGE_TAG"
          # set output to be used by the deploy step
          echo "image-tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      # 1. Login a Azure (Requiere secreto AZURE_CREDENTIALS)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      # 2. Despliegue a Azure Container App
      - name: Desplegar imagen a Azure Container App
        uses: azure/container-apps-deploy-action@v1
        with:
          # Sustituye estos valores con los de tu entorno Azure
          resourceGroup: 'UNA-CHAT'
          containerAppName: 'una-chat-app'
          # Se usa el tag de la imagen que se leyó del evento disparador
          imageToDeploy: ${{ steps.event_data.outputs.image-tag }} 